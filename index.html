<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Dormitorios de Operadores</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- ESTILOS CSS (Sin cambios, se mantiene el estilo original) --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 30px;
            background: rgba(255,255,255,0.1);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .initial-screen {
            text-align: center;
            padding: 80px 40px;
        }

        .initial-screen h2 {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .initial-screen p {
            font-size: 1.2rem;
            color: #7f8c8d;
            margin-bottom: 40px;
        }

        .access-buttons {
            display: flex;
            gap: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .access-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 25px 40px;
            border: none;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .access-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(52,152,219,0.3);
        }

        .access-btn.admin {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .access-btn.admin:hover {
            box-shadow: 0 15px 30px rgba(231,76,60,0.3);
        }

        .login-screen, .main-system, .admin-panel {
            display: none;
            padding: 40px;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            background: #f8f9fa;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .login-form h3 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 1.5rem;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            border: none;
            background: none;
            color: #495057;
        }
        
        .tab:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }
        
        .tab.active {
            background: #007bff;
            color: white;
            box-shadow: inset 0 -3px 0 #0056b3;
        }

        .content {
            display: none;
            padding: 40px 0;
            animation: fadeIn 0.5s ease-in;
        }

        .content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
            background: white;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 20px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            transform: scale(1.5);
        }

        .btn-submit {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40,167,69,0.3);
        }
        
        .btn-back {
            background: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .btn-back:hover {
            background: #5a6268;
        }
        
        .operator-info {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #bee5eb;
        }
        
        .success-message, .error-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .occupancy-map {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .occupancy-map h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .room {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        .room h5 { margin-bottom: 10px; color: #343a40;}
        .room-beds { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; }
        
        .room.occupied {
            border-color: #dc3545;
            background: #fff5f5;
        }
        
        .room.available {
            border-color: #28a745;
            background: #f8fff9;
        }
        
        .bed {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 25px;
            margin: 2px;
            border-radius: 3px;
            font-size: 0.8rem;
            color: white;
            font-weight: bold;
        }
        
        .bed.occupied { background: #dc3545; }
        .bed.available { background: #28a745; }
        
        .admin-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
        }
        
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .admin-tab {
            background: #6c757d;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .admin-tab:hover { background: #5a6268; }
        .admin-tab.active { background: #007bff; }
        
        .statistics-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        #lista-usuarios, #lista-operadores, #lista-habitaciones { margin-top: 20px; }
        .list-item {
             background: #fff; padding: 15px; border-radius: 8px;
             margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
             box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .btn-delete { background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }

        @media (max-width: 768px) {
            .tabs { flex-direction: column; }
            .form-row { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.8rem; }
            .access-buttons { flex-direction: column; align-items: center; }
            .user-info { position: static; margin-top: 20px; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏢 Control de Dormitorios</h1>
            <p>Sistema de Gestión de Operadores</p>
            <div class="user-info" id="user-info" style="display: none;">
                <i class="fas fa-user"></i> <span id="current-user"></span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>

        <div class="initial-screen" id="initial-screen">
            <h2>Bienvenido al Sistema de Control de Dormitorios</h2>
            <p>Seleccione el tipo de acceso para continuar</p>
            <div class="access-buttons">
                <button class="access-btn" onclick="showLogin('registro')">
                    <i class="fas fa-clipboard-list"></i><br>
                    Panel de Registro
                </button>
                <button class="access-btn admin" onclick="showLogin('admin')">
                    <i class="fas fa-user-shield"></i><br>
                    Panel de Administrador
                </button>
            </div>
        </div>

        <div class="login-screen" id="login-screen">
            <button class="btn-back" onclick="showInitialScreen()">
                <i class="fas fa-arrow-left"></i> Regresar
            </button>
            <div class="login-form">
                <h3 id="login-title">Iniciar Sesión</h3>
                <form id="form-login">
                    <div class="form-group">
                        <label for="email"><i class="fas fa-envelope"></i> Correo:</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="password"><i class="fas fa-key"></i> Contraseña:</label>
                        <input type="password" id="password" required>
                    </div>
                     <div class="error-message" id="error-login"></div>
                    <button type="submit" class="btn-submit">
                        <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                    </button>
                </form>
            </div>
        </div>
        
        <div class="main-system" id="main-system">
            <div class="tabs">
                <button class="tab active" onclick="showTab('entrada-inicial')">🔑 Entrada Inicial</button>
                <button class="tab" onclick="showTab('salida-intermedia')">🚪 Salida Intermedia</button>
                <button class="tab" onclick="showTab('entrada-intermedia')">🔄 Entrada Intermedia</button>
                <button class="tab" onclick="showTab('salida-final')">✅ Salida Final</button>
            </div>

            <div id="entrada-inicial" class="content active">
                <h2>🔑 Entrada Inicial al Dormitorio</h2>
                <div class="success-message" id="success-entrada-inicial"></div>
                <div class="error-message" id="error-entrada-inicial"></div>
                <form id="form-entrada-inicial">
                    <div class="form-group">
                        <label for="clave-entrada">Clave del Operador:</label>
                        <input type="text" id="clave-entrada" required>
                    </div>
                    <div class="operator-info" id="info-entrada" style="display: none;">
                        <p id="nombre-entrada"></p>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="habitacion-entrada">Habitación:</label>
                            <select id="habitacion-entrada" required><option value="">Seleccione habitación</option></select>
                        </div>
                        <div class="form-group">
                            <label for="cama-entrada">Cama:</label>
                            <select id="cama-entrada" required><option value="">Seleccione cama</option></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="hora-turno">Hora de Turno:</label>
                            <input type="time" id="hora-turno" required>
                        </div>
                        <div class="form-group">
                            <label for="hora-levantado">Hora para ser Levantado:</label>
                            <input type="time" id="hora-levantado" required>
                        </div>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="licencia-retenida" required>
                        <label for="licencia-retenida">Licencia retenida</label>
                    </div>
                    <button type="submit" class="btn-submit">Registrar Entrada</button>
                </form>
                <div class="occupancy-map">
                    <h4>📊 Esquema de Ocupación</h4>
                    <div class="rooms-grid" id="rooms-grid"></div>
                </div>
            </div>

            <div id="salida-intermedia" class="content">
                <h2>🚪 Salida Intermedia</h2>
                <div class="success-message" id="success-salida-intermedia"></div>
                <div class="error-message" id="error-salida-intermedia"></div>
                <form id="form-salida-intermedia">
                    <div class="form-group">
                        <label for="clave-salida-int">Clave del Operador:</label>
                        <input type="text" id="clave-salida-int" required>
                    </div>
                    <div class="operator-info" id="info-salida-int" style="display: none;">
                         <p id="nombre-salida-int"></p>
                    </div>
                    <div class="form-group">
                        <label for="motivo-salida">Motivo de Salida:</label>
                        <select id="motivo-salida" required>
                            <option value="">Seleccionar motivo</option>
                            <option value="comida">Comida</option>
                            <option value="emergencia">Emergencia</option>
                            <option value="personal">Asunto Personal</option>
                            <option value="trabajo">Trabajo</option>
                            <option value="otros">Otros</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-submit">Registrar Salida</button>
                </form>
            </div>

            <div id="entrada-intermedia" class="content">
                 <h2>🔄 Entrada Intermedia</h2>
                <div class="success-message" id="success-entrada-intermedia"></div>
                <div class="error-message" id="error-entrada-intermedia"></div>
                <form id="form-entrada-intermedia">
                     <div class="form-group">
                        <label for="clave-entrada-int">Clave del Operador:</label>
                        <input type="text" id="clave-entrada-int" required>
                    </div>
                    <div class="operator-info" id="info-entrada-int" style="display: none;">
                        <p id="nombre-entrada-int"></p>
                    </div>
                    <div class="form-group">
                        <label for="observaciones-entrada-int">Observaciones:</label>
                        <textarea id="observaciones-entrada-int" rows="4" placeholder="Ingrese observaciones si las hay..."></textarea>
                    </div>
                    <button type="submit" class="btn-submit">Registrar Entrada</button>
                </form>
            </div>
            
            <div id="salida-final" class="content">
                 <h2>✅ Salida Final</h2>
                <div class="success-message" id="success-salida-final"></div>
                <div class="error-message" id="error-salida-final"></div>
                <form id="form-salida-final">
                    <div class="form-group">
                        <label for="clave-salida-final">Clave del Operador:</label>
                        <input type="text" id="clave-salida-final" required>
                    </div>
                    <div class="operator-info" id="info-salida-final" style="display: none;">
                        <p id="nombre-salida-final"></p>
                        <p id="habitacion-salida-final"></p>
                    </div>
                     <div class="checkbox-group">
                        <input type="checkbox" id="licencia-devuelta" required>
                        <label for="licencia-devuelta">Licencia devuelta</label>
                    </div>
                    <div class="form-group">
                        <label for="observaciones-salida">Observaciones:</label>
                        <textarea id="observaciones-salida" rows="4" placeholder="Ingrese observaciones finales..."></textarea>
                    </div>
                    <button type="submit" class="btn-submit">Registrar Salida Final</button>
                </form>
            </div>
        </div>

        <div class="admin-panel" id="admin-panel">
            <h2>🛠️ Panel de Administración</h2>
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="showAdminTab('usuarios')">👥 Gestión de Usuarios</button>
                <button class="admin-tab" onclick="showAdminTab('operadores')">👷 Gestión de Operadores</button>
                <button class="admin-tab" onclick="showAdminTab('habitaciones')">🏠 Gestión de Habitaciones</button>
                <button class="admin-tab" onclick="showAdminTab('estadisticas')">📊 Estadísticas</button>
            </div>
            
            <div class="success-message" id="success-admin"></div>
            <div class="error-message" id="error-admin"></div>

            <div id="admin-usuarios" class="admin-section">
                <h3>Gestión de Usuarios del Sistema</h3>
                <form id="form-crear-usuario">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nuevo-email">Email:</label>
                            <input type="email" id="nuevo-email" required>
                        </div>
                        <div class="form-group">
                            <label for="nueva-password">Contraseña:</label>
                            <input type="password" id="nueva-password" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="tipo-usuario">Tipo de Usuario:</label>
                        <select id="tipo-usuario" required>
                            <option value="registro">Registro</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-submit">Crear Usuario</button>
                </form>
                <h4>Usuarios Existentes:</h4>
                <div id="lista-usuarios"></div>
            </div>

            <div id="admin-operadores" class="admin-section" style="display: none;">
                 <h3>Gestión de Operadores</h3>
                <form id="form-operador">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="clave-operador">Clave:</label>
                            <input type="text" id="clave-operador" required>
                        </div>
                        <div class="form-group">
                            <label for="nombre-operador">Nombre Completo:</label>
                            <input type="text" id="nombre-operador" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-submit">Agregar/Actualizar Operador</button>
                </form>
                 <h4>Operadores Existentes:</h4>
                <div id="lista-operadores"></div>
            </div>
            
            <div id="admin-habitaciones" class="admin-section" style="display: none;">
                <h3>Gestión de Habitaciones y Camas</h3>
                <form id="form-habitacion">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="numero-habitacion">Número de Habitación:</label>
                            <input type="text" id="numero-habitacion" placeholder="Ej: H101" required>
                        </div>
                        <div class="form-group">
                            <label for="numero-camas">Número de Camas:</label>
                            <input type="number" id="numero-camas" min="1" max="8" value="2" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-submit">Agregar Habitación</button>
                </form>
                <h4>Habitaciones Existentes:</h4>
                <div id="lista-habitaciones"></div>
            </div>

            <div id="admin-estadisticas" class="admin-section" style="display: none;">
                 <h3>Estadísticas y Reportes</h3>
                <div class="statistics-filters">
                    <div class="form-group">
                        <label for="filtro-operador">Operador:</label>
                        <select id="filtro-operador"><option value="">Todos</option></select>
                    </div>
                    <div class="form-group">
                        <label for="fecha-inicio">Fecha Inicio:</label>
                        <input type="date" id="fecha-inicio" required>
                    </div>
                    <div class="form-group">
                        <label for="fecha-fin">Fecha Fin:</label>
                        <input type="date" id="fecha-fin" required>
                    </div>
                </div>
                 <button onclick="generarEstadisticas()" class="btn-submit">Generar Reporte</button>
                <div id="resultados-estadisticas" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        // ¡IMPORTANTE! Reemplaza esta configuración con la de tu proyecto Firebase
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_AUTH_DOMAIN",
            databaseURL: "TU_DATABASE_URL",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_STORAGE_BUCKET",
            messagingSenderId: "TU_MESSAGING_SENDER_ID",
            appId: "TU_APP_ID"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // --- Variables Globales y Estado ---
        let currentUserType = '';
        let operadoresData = {};

        // --- MANEJO DE AUTENTICACIÓN Y NAVEGACIÓN ---

        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('current-user').textContent = user.email;
                document.getElementById('user-info').style.display = 'block';
                cargarDatosIniciales(); // Cargar datos necesarios al iniciar sesión
            } else {
                document.getElementById('user-info').style.display = 'none';
                showInitialScreen();
            }
        });
        
        function showInitialScreen() {
            hideAllScreens();
            document.getElementById('initial-screen').style.display = 'block';
        }

        function showLogin(type) {
            currentUserType = type;
            hideAllScreens();
            document.getElementById('login-screen').style.display = 'block';
            document.getElementById('login-title').textContent = type === 'admin' ? 'Acceso de Administrador' : 'Acceso de Registro';
            document.getElementById('form-login').reset();
            hideMessage('login');
        }

        function hideAllScreens() {
            document.getElementById('initial-screen').style.display = 'none';
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-system').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'none';
        }

        function logout() {
            auth.signOut().then(() => {
                showInitialScreen();
                currentUserType = '';
            });
        }

        document.getElementById('form-login').addEventListener('submit', function(e) {
            e.preventDefault();
            hideMessage('login');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => db.ref('usuarios/' + userCredential.user.uid).once('value'))
                .then(snapshot => {
                    const userData = snapshot.val();
                    if (userData && userData.tipo === currentUserType) {
                        hideAllScreens();
                        if (currentUserType === 'admin') {
                            document.getElementById('admin-panel').style.display = 'block';
                        } else {
                            document.getElementById('main-system').style.display = 'block';
                        }
                    } else {
                        auth.signOut(); // Desloguear si el tipo no es correcto
                        showMessage('error', 'Acceso denegado. Rol de usuario no válido para este panel.', 'login');
                    }
                })
                .catch(error => {
                    showMessage('error', `Error: ${error.message}`, 'login');
                });
        });

        // --- FUNCIONES DE UTILIDAD (MENSAJES, ETC.) ---

        function showMessage(type, message, context) {
            const successEl = document.getElementById(`success-${context}`);
            const errorEl = document.getElementById(`error-${context}`);
            if (type === 'success') {
                successEl.textContent = message;
                successEl.style.display = 'block';
                errorEl.style.display = 'none';
                setTimeout(() => successEl.style.display = 'none', 5000);
            } else {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                successEl.style.display = 'none';
            }
        }
        
        function hideMessage(context) {
             document.getElementById(`success-${context}`).style.display = 'none';
             document.getElementById(`error-${context}`).style.display = 'none';
        }


        // --- CARGA DE DATOS INICIALES ---
        function cargarDatosIniciales() {
            // Cargar operadores
            db.ref('operadores').on('value', snapshot => {
                operadoresData = snapshot.val() || {};
                 // Poblar filtro de operadores en estadísticas
                const filtroOperadorSelect = document.getElementById('filtro-operador');
                filtroOperadorSelect.innerHTML = '<option value="">Todos</option>';
                for (const clave in operadoresData) {
                    filtroOperadorSelect.innerHTML += `<option value="${clave}">${clave} - ${operadoresData[clave].nombre}</option>`;
                }
            });

            // Cargar habitaciones y actualizar mapa de ocupación en tiempo real
            db.ref('habitaciones').on('value', snapshot => {
                const habitaciones = snapshot.val() || {};
                actualizarMapaOcupacion(habitaciones);
                poblarHabitacionesDisponibles(habitaciones);
            });
        }
        
        // --- FUNCIONALIDAD DEL PANEL DE REGISTRO ---

        function showTab(tabId) {
            // Ocultar todos los contenidos y desactivar todos los tabs
            document.querySelectorAll('.main-system .content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.main-system .tab').forEach(t => t.classList.remove('active'));
            // Mostrar el contenido y activar el tab seleccionado
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // --- LÓGICA DE ENTRADA INICIAL ---
        
        const claveEntradaInput = document.getElementById('clave-entrada');
        claveEntradaInput.addEventListener('blur', () => {
            const clave = claveEntradaInput.value.trim();
            const infoDiv = document.getElementById('info-entrada');
            const nombreP = document.getElementById('nombre-entrada');
            if (operadoresData[clave]) {
                nombreP.textContent = `Nombre: ${operadoresData[clave].nombre}`;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
                if(clave) showMessage('error', 'Clave de operador no encontrada.', 'entrada-inicial');
            }
        });

        function actualizarMapaOcupacion(habitaciones) {
            const grid = document.getElementById('rooms-grid');
            grid.innerHTML = '';
            Object.keys(habitaciones).sort().forEach(numHab => {
                const hab = habitaciones[numHab];
                const roomDiv = document.createElement('div');
                roomDiv.classList.add('room');
                roomDiv.innerHTML = `<h5>Hab. ${numHab}</h5>`;
                
                const bedsDiv = document.createElement('div');
                bedsDiv.classList.add('room-beds');

                let allAvailable = true;
                Object.keys(hab.camas).sort().forEach(numCama => {
                    const cama = hab.camas[numCama];
                    const bedSpan = document.createElement('span');
                    bedSpan.classList.add('bed');
                    bedSpan.classList.add(cama.estado === 'ocupada' ? 'occupied' : 'available');
                    bedSpan.textContent = numCama;
                    bedsDiv.appendChild(bedSpan);
                    if (cama.estado === 'ocupada') allAvailable = false;
                });
                roomDiv.appendChild(bedsDiv);
                roomDiv.classList.add(allAvailable ? 'available' : 'occupied');
                grid.appendChild(roomDiv);
            });
        }

        function poblarHabitacionesDisponibles(habitaciones) {
            const selectHab = document.getElementById('habitacion-entrada');
            selectHab.innerHTML = '<option value="">Seleccionar habitación</option>';
            Object.keys(habitaciones).forEach(numHab => {
                const camasDisponibles = Object.values(habitaciones[numHab].camas).some(c => c.estado === 'disponible');
                if (camasDisponibles) {
                    selectHab.innerHTML += `<option value="${numHab}">${numHab}</option>`;
                }
            });

            selectHab.onchange = () => {
                const selectCama = document.getElementById('cama-entrada');
                selectCama.innerHTML = '<option value="">Seleccionar cama</option>';
                const numHabSeleccionada = selectHab.value;
                if (numHabSeleccionada) {
                    const camas = habitaciones[numHabSeleccionada].camas;
                    Object.keys(camas).forEach(numCama => {
                        if (camas[numCama].estado === 'disponible') {
                             selectCama.innerHTML += `<option value="${numCama}">${numCama}</option>`;
                        }
                    });
                }
            };
        }

        document.getElementById('form-entrada-inicial').addEventListener('submit', function(e){
            e.preventDefault();
            const clave = document.getElementById('clave-entrada').value.trim();
            const habitacion = document.getElementById('habitacion-entrada').value;
            const cama = document.getElementById('cama-entrada').value;

            // Validar que el operador no tenga ya una estancia activa
            db.ref('estancias').orderByChild('claveOperador').equalTo(clave).once('value', snapshot => {
                let estanciaActiva = false;
                snapshot.forEach(childSnapshot => {
                    if (childSnapshot.val().estado === 'activa') {
                        estanciaActiva = true;
                    }
                });

                if (estanciaActiva) {
                    showMessage('error', 'Este operador ya tiene una entrada activa.', 'entrada-inicial');
                    return;
                }
                
                // Si no hay estancia activa, proceder con el registro
                const nuevaEstancia = {
                    claveOperador: clave,
                    nombreOperador: operadoresData[clave]?.nombre || 'N/A',
                    habitacion: habitacion,
                    cama: cama,
                    horaTurno: document.getElementById('hora-turno').value,
                    horaLevantado: document.getElementById('hora-levantado').value,
                    licenciaRetenida: document.getElementById('licencia-retenida').checked,
                    fechaHoraEntradaInicial: new Date().toISOString(),
                    usuarioRegistro: auth.currentUser.email,
                    estado: 'activa',
                    movimientos: {},
                    fechaHoraSalidaFinal: null,
                };

                const nuevaEstanciaRef = db.ref('estancias').push();
                nuevaEstanciaRef.set(nuevaEstancia)
                    .then(() => db.ref(`habitaciones/${habitacion}/camas/${cama}`).update({ estado: 'ocupada', claveOperador: clave }))
                    .then(() => {
                        showMessage('success', 'Entrada registrada exitosamente.', 'entrada-inicial');
                        document.getElementById('form-entrada-inicial').reset();
                        document.getElementById('info-entrada').style.display = 'none';
                    })
                    .catch(error => showMessage('error', `Error: ${error.message}`, 'entrada-inicial'));
            });
        });

        // --- LÓGICA SALIDAS Y ENTRADAS INTERMEDIAS Y FINAL ---
        
        // Función genérica para buscar estancia activa y mostrar info del operador
        function buscarOperadorActivo(inputId, infoDivId, nombrePId, context) {
            const input = document.getElementById(inputId);
            input.addEventListener('blur', () => {
                const clave = input.value.trim();
                const infoDiv = document.getElementById(infoDivId);
                const nombreP = document.getElementById(nombrePId);
                const habitacionP = document.getElementById('habitacion-salida-final'); // Específico para salida final
                infoDiv.style.display = 'none';
                hideMessage(context);

                if (!clave) return;

                db.ref('estancias').orderByChild('claveOperador').equalTo(clave).once('value', snapshot => {
                    let estanciaEncontrada = null;
                    snapshot.forEach(child => {
                        if (child.val().estado === 'activa') {
                            estanciaEncontrada = child.val();
                            estanciaEncontrada.id = child.key;
                        }
                    });

                    if (estanciaEncontrada) {
                        infoDiv.dataset.estanciaId = estanciaEncontrada.id; // Guardar ID para usarlo en el submit
                        nombreP.textContent = `Nombre: ${estanciaEncontrada.nombreOperador}`;
                        if(habitacionP) habitacionP.textContent = `Ocupando: Hab. ${estanciaEncontrada.habitacion} - Cama ${estanciaEncontrada.cama}`;
                        infoDiv.style.display = 'block';
                    } else {
                        showMessage('error', 'No se encontró una estancia activa para este operador.', context);
                    }
                });
            });
        }
        
        buscarOperadorActivo('clave-salida-int', 'info-salida-int', 'nombre-salida-int', 'salida-intermedia');
        buscarOperadorActivo('clave-entrada-int', 'info-entrada-int', 'nombre-entrada-int', 'entrada-intermedia');
        buscarOperadorActivo('clave-salida-final', 'info-salida-final', 'nombre-salida-final', 'salida-final');

        // Salida Intermedia Submit
        document.getElementById('form-salida-intermedia').addEventListener('submit', function(e) {
            e.preventDefault();
            const estanciaId = document.getElementById('info-salida-int').dataset.estanciaId;
            if (!estanciaId) {
                 showMessage('error', 'Primero busque un operador con estancia activa.', 'salida-intermedia');
                 return;
            }
            const movimiento = {
                tipo: 'salida_intermedia',
                motivo: document.getElementById('motivo-salida').value,
                fechaHora: new Date().toISOString()
            };
            db.ref(`estancias/${estanciaId}/movimientos`).push(movimiento)
                .then(() => {
                     showMessage('success', 'Salida intermedia registrada.', 'salida-intermedia');
                     this.reset();
                     document.getElementById('info-salida-int').style.display = 'none';
                })
                .catch(error => showMessage('error', `Error: ${error.message}`, 'salida-intermedia'));
        });
        
        // Entrada Intermedia Submit
        document.getElementById('form-entrada-intermedia').addEventListener('submit', function(e) {
            e.preventDefault();
            const estanciaId = document.getElementById('info-entrada-int').dataset.estanciaId;
            if (!estanciaId) {
                 showMessage('error', 'Primero busque un operador con estancia activa.', 'entrada-intermedia');
                 return;
            }
            const movimiento = {
                tipo: 'entrada_intermedia',
                observaciones: document.getElementById('observaciones-entrada-int').value,
                fechaHora: new Date().toISOString()
            };
            db.ref(`estancias/${estanciaId}/movimientos`).push(movimiento)
                .then(() => {
                     showMessage('success', 'Entrada intermedia registrada.', 'entrada-intermedia');
                     this.reset();
                     document.getElementById('info-entrada-int').style.display = 'none';
                })
                .catch(error => showMessage('error', `Error: ${error.message}`, 'entrada-intermedia'));
        });

        // Salida Final Submit
        document.getElementById('form-salida-final').addEventListener('submit', function(e) {
            e.preventDefault();
            const estanciaId = document.getElementById('info-salida-final').dataset.estanciaId;
             if (!estanciaId) {
                 showMessage('error', 'Primero busque un operador con estancia activa.', 'salida-final');
                 return;
            }

            db.ref(`estancias/${estanciaId}`).once('value', snapshot => {
                const estancia = snapshot.val();
                const updates = {
                    estado: 'finalizada',
                    fechaHoraSalidaFinal: new Date().toISOString(),
                    licenciaDevuelta: document.getElementById('licencia-devuelta').checked,
                    observacionesSalida: document.getElementById('observaciones-salida').value
                };

                db.ref(`estancias/${estanciaId}`).update(updates)
                    .then(() => db.ref(`habitaciones/${estancia.habitacion}/camas/${estancia.cama}`).update({ estado: 'disponible', claveOperador: null }))
                    .then(() => {
                        showMessage('success', 'Salida final registrada. La cama ha sido liberada.', 'salida-final');
                        this.reset();
                        document.getElementById('info-salida-final').style.display = 'none';
                    })
                    .catch(error => showMessage('error', `Error: ${error.message}`, 'salida-final'));
            });
        });

        
        // --- FUNCIONALIDAD DEL PANEL DE ADMINISTRADOR ---

        function showAdminTab(tabId) {
            document.querySelectorAll('.admin-section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`admin-${tabId}`).style.display = 'block';
            event.currentTarget.classList.add('active');
            hideMessage('admin');
        }

        // Gestión de Usuarios
        document.getElementById('form-crear-usuario').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('nuevo-email').value;
            const password = document.getElementById('nueva-password').value;
            const tipo = document.getElementById('tipo-usuario').value;

            // Se crea un segundo app de Firebase para no desloguear al admin actual
            const secondaryApp = firebase.initializeApp(firebaseConfig, "secondary");
            
            secondaryApp.auth().createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const uid = userCredential.user.uid;
                    return db.ref('usuarios/' + uid).set({ email: email, tipo: tipo });
                })
                .then(() => {
                    showMessage('success', 'Usuario creado exitosamente.', 'admin');
                    this.reset();
                    secondaryApp.auth().signOut(); // Se cierra sesión en la app secundaria
                })
                .catch(error => {
                    showMessage('error', `Error: ${error.message}`, 'admin');
                    secondaryApp.auth().signOut();
                });
        });
        
        db.ref('usuarios').on('value', snapshot => {
            const lista = document.getElementById('lista-usuarios');
            lista.innerHTML = '';
            snapshot.forEach(child => {
                const user = child.val();
                const uid = child.key;
                lista.innerHTML += `
                    <div class="list-item" id="user-${uid}">
                        <span>${user.email} (${user.tipo})</span>
                        <button class="btn-delete" onclick="borrarUsuario('${uid}')">Borrar</button>
                    </div>`;
            });
        });
        
        function borrarUsuario(uid) {
             if (confirm('¿Está seguro de que desea borrar este usuario? Esta acción no se puede deshacer.')) {
                 // Nota: Borrar usuarios de Auth requiere un backend (Cloud Functions) por seguridad.
                 // Aquí solo lo borraremos de la Realtime Database.
                 db.ref('usuarios/' + uid).remove()
                    .then(() => showMessage('success', 'Usuario borrado de la base de datos.', 'admin'))
                    .catch(error => showMessage('error', error.message, 'admin'));
             }
        }

        // Gestión de Operadores
        document.getElementById('form-operador').addEventListener('submit', function(e) {
            e.preventDefault();
            const clave = document.getElementById('clave-operador').value.trim();
            const nombre = document.getElementById('nombre-operador').value.trim();
            db.ref('operadores/' + clave).set({ nombre: nombre })
                .then(() => {
                    showMessage('success', 'Operador guardado.', 'admin');
                    this.reset();
                })
                .catch(error => showMessage('error', error.message, 'admin'));
        });

        db.ref('operadores').on('value', snapshot => {
            const lista = document.getElementById('lista-operadores');
            lista.innerHTML = '';
            snapshot.forEach(child => {
                const op = child.val();
                const clave = child.key;
                lista.innerHTML += `
                    <div class="list-item">
                        <span>${clave}: ${op.nombre}</span>
                        <button class="btn-delete" onclick="borrarOperador('${clave}')">Borrar</button>
                    </div>`;
            });
        });
        function borrarOperador(clave){
            if (confirm('¿Seguro que desea borrar este operador?')) {
                db.ref('operadores/' + clave).remove()
                .then(() => showMessage('success', 'Operador borrado.', 'admin'))
                .catch(error => showMessage('error', error.message, 'admin'));
            }
        }

        // Gestión de Habitaciones
        document.getElementById('form-habitacion').addEventListener('submit', function(e) {
            e.preventDefault();
            const numHab = document.getElementById('numero-habitacion').value.trim();
            const numCamas = parseInt(document.getElementById('numero-camas').value);
            const camas = {};
            for(let i = 1; i <= numCamas; i++) {
                camas[`C${i}`] = { estado: 'disponible' };
            }
            db.ref('habitaciones/' + numHab).set({ numeroCamas: numCamas, camas: camas })
                .then(() => {
                    showMessage('success', 'Habitación guardada.', 'admin');
                    this.reset();
                })
                .catch(error => showMessage('error', error.message, 'admin'));
        });
        
        db.ref('habitaciones').on('value', snapshot => {
            const lista = document.getElementById('lista-habitaciones');
            lista.innerHTML = '';
            snapshot.forEach(child => {
                const hab = child.val();
                const numHab = child.key;
                lista.innerHTML += `
                    <div class="list-item">
                        <span>Hab. ${numHab} (${hab.numeroCamas} camas)</span>
                        <button class="btn-delete" onclick="borrarHabitacion('${numHab}')">Borrar</button>
                    </div>`;
            });
        });
        function borrarHabitacion(numHab){
            if (confirm('¿Seguro que desea borrar esta habitación?')) {
                 db.ref('habitaciones/' + numHab).remove()
                .then(() => showMessage('success', 'Habitación borrada.', 'admin'))
                .catch(error => showMessage('error', error.message, 'admin'));
            }
        }
        
        // Estadísticas
        function generarEstadisticas() {
            const resultadosDiv = document.getElementById('resultados-estadisticas');
            resultadosDiv.innerHTML = 'Generando reporte...';

            const claveOperador = document.getElementById('filtro-operador').value;
            const fechaInicio = document.getElementById('fecha-inicio').value;
            const fechaFin = document.getElementById('fecha-fin').value;
            
            if (!fechaInicio || !fechaFin) {
                resultadosDiv.innerHTML = '<p style="color: red;">Por favor, seleccione un rango de fechas.</p>';
                return;
            }

            const inicioMs = new Date(fechaInicio + 'T00:00:00').getTime();
            const finMs = new Date(fechaFin + 'T23:59:59').getTime();
            const totalHorasRango = (finMs - inicioMs) / (1000 * 60 * 60);

            let totalCamas = 0;
            db.ref('habitaciones').once('value', habSnapshot => {
                habSnapshot.forEach(hab => {
                    totalCamas += hab.val().numeroCamas;
                });

                db.ref('estancias').once('value', estanciasSnapshot => {
                    let horasOcupadasTotales = 0;
                    let estanciasFiltradas = [];

                    estanciasSnapshot.forEach(child => {
                        const estancia = child.val();
                        
                        // Filtrar por operador si se seleccionó uno
                        if(claveOperador && estancia.claveOperador !== claveOperador) return;

                        const entradaMs = new Date(estancia.fechaHoraEntradaInicial).getTime();
                        const salidaMs = estancia.fechaHoraSalidaFinal ? new Date(estancia.fechaHoraSalidaFinal).getTime() : finMs;

                        // Verificar si la estancia se solapa con el rango de fechas
                        if (entradaMs < finMs && salidaMs > inicioMs) {
                            estanciasFiltradas.push(estancia);
                            
                            const inicioCalculo = Math.max(entradaMs, inicioMs);
                            const finCalculo = Math.min(salidaMs, finMs);
                            const horasOcupadas = (finCalculo - inicioCalculo) / (1000 * 60 * 60);
                            
                            horasOcupadasTotales += horasOcupadas;
                        }
                    });
                    
                    const totalHorasCamaDisponibles = totalCamas * totalHorasRango;
                    const porcentajeOcupacion = totalHorasCamaDisponibles > 0 ? (horasOcupadasTotales / totalHorasCamaDisponibles) * 100 : 0;
                    
                    let htmlResultados = `
                        <h4>Resultados del ${fechaInicio} al ${fechaFin}</h4>
                        <p><strong>Operador:</strong> ${claveOperador || 'Todos'}</p>
                        <p><strong>Porcentaje de Ocupación de Camas:</strong> ${porcentajeOcupacion.toFixed(2)}%</p>
                        <hr>
                        <h5>Estancias en el periodo (${estanciasFiltradas.length}):</h5>
                    `;
                    if (estanciasFiltradas.length > 0) {
                        htmlResultados += '<ul>';
                        estanciasFiltradas.forEach(e => {
                           htmlResultados += `<li>Operador ${e.claveOperador} en Hab. ${e.habitacion} (Cama ${e.cama}) desde ${new Date(e.fechaHoraEntradaInicial).toLocaleString()} hasta ${e.fechaHoraSalidaFinal ? new Date(e.fechaHoraSalidaFinal).toLocaleString() : 'ACTUAL'}</li>`;
                        });
                        htmlResultados += '</ul>';
                    } else {
                        htmlResultados += '<p>No se encontraron estancias en este periodo.</p>';
                    }
                    
                    resultadosDiv.innerHTML = htmlResultados;
                });
            });
        }
    </script>
</body>
</html>
